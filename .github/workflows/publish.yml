name: Publish Extension

on:
  push:
    tags: ['v[0-9]+.[0-9]+.[0-9]+']

permissions:
  contents: write

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - run: git config --global user.name "CI Test" && git config --global user.email "ci@test.com" && git config --global init.defaultBranch main
      - run: bun install --frozen-lockfile
      - run: bun test test/commands test/git-sort test/mocks test/services test/tree-view test/ui test/utils test/types test/builders test/factories test/integration

  publish:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
      - uses: oven-sh/setup-bun@v2
      - run: bun install --frozen-lockfile
      - run: bun run dist -- --no-install

      # Validate build output exists
      - name: Validate build
        run: |
          if [ ! -f "dist/extension.js" ] || [ ! -s "dist/extension.js" ]; then
            echo "::error::Build produced empty or missing dist/extension.js"
            exit 1
          fi

      # Parse tag, validate format, check package.json match, determine channel
      # Microsoft recommended convention: https://code.visualstudio.com/api/working-with-extensions/publishing-extension#prerelease-extensions
      - name: Determine release channel
        id: channel
        run: |
          TAG="${GITHUB_REF#refs/tags/}"

          # Strict format validation (injection protection)
          if [[ ! "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Invalid tag format: $TAG (expected vMAJOR.MINOR.PATCH)"
            exit 1
          fi

          VERSION="${TAG#v}"
          MINOR=$(echo "$VERSION" | cut -d. -f2)

          # Verify tag matches package.json
          PKG_VERSION=$(node -p "require('./package.json').version")
          if [ "$VERSION" != "$PKG_VERSION" ]; then
            echo "::error::Tag version ($VERSION) does not match package.json ($PKG_VERSION)"
            exit 1
          fi

          # Odd minor = pre-release, even minor = stable
          if [ $((MINOR % 2)) -eq 1 ]; then
            echo "prerelease=true" >> $GITHUB_OUTPUT
            echo "üöÄ Pre-release channel (v$VERSION ‚Äî minor $MINOR is odd)"
          else
            echo "prerelease=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Stable channel (v$VERSION ‚Äî minor $MINOR is even)"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Publish stable
        if: steps.channel.outputs.prerelease == 'false'
        run: npx @vscode/vsce publish --no-dependencies
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}

      - name: Publish pre-release
        if: steps.channel.outputs.prerelease == 'true'
        run: npx @vscode/vsce publish --pre-release --no-dependencies
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "${{ steps.channel.outputs.prerelease == 'true' && 'üöÄ Pre-release' || '‚úÖ Release' }} ${{ steps.channel.outputs.version }}"
          body: |
            ${{ steps.channel.outputs.prerelease == 'true' && '‚ö†Ô∏è **Pre-release** ‚Äî may contain experimental features.' || '**Stable release.**' }}
          prerelease: ${{ steps.channel.outputs.prerelease == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
