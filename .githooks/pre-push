#!/usr/bin/env bash
# Per-repo pre-push â€” command-central specific checks
# This runs AFTER global hooks (biome ci + bun test already passed)
# Only contains checks that are specific to this VS Code extension project
#
# If running standalone (core.hooksPath = .githooks), do everything.
# If running under global hooks (__GIT_GLOBAL_HOOKS=1), skip what's already done.

set -euo pipefail

# --- Version alignment (always â€” this is repo-specific) ---
echo "ğŸ”’ Checking version alignment..."
ENGINE_VS=$(node -e "console.log(require('./package.json').engines.vscode.replace('^',''))")
TYPES_VS=$(node -e "console.log(require('./package.json').devDependencies['@types/vscode'].replace('^',''))")
if [ "$(printf '%s\n' "$ENGINE_VS" "$TYPES_VS" | sort -V | head -1)" != "$ENGINE_VS" ]; then
  if [ "$TYPES_VS" != "$ENGINE_VS" ]; then
    echo "âŒ @types/vscode ($TYPES_VS) > engines.vscode ($ENGINE_VS)"
    echo "   VSCE will reject this. Fix package.json."
    exit 1
  fi
fi
echo "   âœ“ @types/vscode ($TYPES_VS) â‰¤ engines.vscode ($ENGINE_VS)"

# --- Dist build verification (always â€” repo-specific) ---
echo "ğŸ“¦ Verifying dist build..."
bun run dist -- --no-install --dry-run

# --- Standalone mode: run global-equivalent checks too ---
if [ -z "${__GIT_GLOBAL_HOOKS:-}" ]; then
  echo "ğŸ§ª Running tests..."
  bun test 2>&1 | tail -5

  echo "ğŸ” Running full lint (CI mode)..."
  bunx biome ci .
fi

echo "âœ… All repo-specific checks passed."
