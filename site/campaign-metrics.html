<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Campaign Metrics ‚Äî Command Central</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#0D1117;color:#e6edf3;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Helvetica,Arial,sans-serif;padding:24px;max-width:960px;margin:0 auto}
h1{font-size:1.4rem;font-weight:600;margin-bottom:4px}
.updated{color:#8b949e;font-size:.85rem;margin-bottom:24px}
.cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px;margin-bottom:32px}
.card{background:#161b22;border:1px solid #30363d;border-radius:12px;padding:20px}
.card .icon{font-size:1.3rem;margin-bottom:4px}
.card .label{color:#8b949e;font-size:.8rem;text-transform:uppercase;letter-spacing:.5px}
.card .value{font-size:2.2rem;font-weight:700;margin:4px 0}
.card .delta{font-size:.85rem;color:#8b949e}
.delta.up{color:#3fb950}
.delta.down{color:#f85149}
h2{font-size:1.1rem;font-weight:600;margin-bottom:12px;color:#8b949e}
.trend{background:#161b22;border:1px solid #30363d;border-radius:12px;padding:20px;margin-bottom:24px}
.sparkline{display:flex;gap:6px;flex-wrap:wrap;font-size:.75rem;color:#8b949e;font-family:monospace}
.sparkline span{background:#21262d;padding:2px 6px;border-radius:4px}
.utm-section{background:#161b22;border:1px solid #30363d;border-radius:12px;padding:20px;margin-bottom:24px}
.utm-row{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #21262d;font-size:.9rem}
.utm-row:last-child{border-bottom:none}
.utm-source{color:#58a6ff}
.error{color:#f85149;text-align:center;padding:40px}
a{color:#58a6ff;text-decoration:none}
a:hover{text-decoration:underline}
</style>
</head>
<body>
<h1>üìà Command Central ‚Äî Campaign Metrics</h1>
<div class="updated" id="updated">Loading‚Ä¶</div>
<div class="cards" id="cards"></div>
<div id="trends"></div>
<div id="utm"></div>
<p style="text-align:center;margin-top:32px"><a href="/">‚Üê Back to site</a></p>

<script>
const REFRESH_MS = 5 * 60 * 1000;

async function load() {
  try {
    const r = await fetch('/data/metrics.json?' + Date.now());
    if (!r.ok) throw new Error(r.status);
    const d = await r.json();
    render(d);
  } catch(e) {
    document.getElementById('updated').textContent = 'Failed to load metrics';
    document.getElementById('cards').innerHTML = '<div class="error">Could not fetch metrics data.</div>';
  }
}

function render(d) {
  const l = d.latest;
  const h = d.history || [];
  const prev = h.length > 1 ? h[h.length - 2] : null;

  // Updated timestamp
  const ts = new Date(d.generated_at || l.timestamp);
  document.getElementById('updated').textContent = 'Last updated: ' + ts.toLocaleString();

  // Cards
  const cards = [
    { icon: 'üè™', label: 'Marketplace Installs', value: l.marketplace?.installs ?? '‚Äî', prev: prev?.marketplace?.installs },
    { icon: '‚≠ê', label: 'GitHub Stars', value: l.github?.stars ?? '‚Äî', prev: prev?.github?.stars },
    { icon: 'üëÅ', label: 'Unique Visitors 30d', value: l.posthog?.visitors ?? '‚Äî', prev: prev?.posthog?.visitors },
    { icon: 'üñ±', label: 'Install Clicks', value: l.posthog?.install_clicks ?? '‚Äî', prev: prev?.posthog?.install_clicks },
    { icon: 'üìß', label: 'Email Submits', value: l.posthog?.email_submits ?? '‚Äî', prev: null },
    { icon: 'üìä', label: 'Scroll 75%+', value: l.posthog?.scroll_depth_75 ?? '‚Äî', prev: null },
  ];

  document.getElementById('cards').innerHTML = cards.map(c => {
    let deltaHtml = '';
    if (c.prev != null && c.value !== '‚Äî') {
      const diff = c.value - c.prev;
      if (diff !== 0) {
        const cls = diff > 0 ? 'up' : 'down';
        const sign = diff > 0 ? '+' : '';
        deltaHtml = `<div class="delta ${cls}">${sign}${diff} from prev</div>`;
      }
    }
    return `<div class="card"><div class="icon">${c.icon}</div><div class="label">${c.label}</div><div class="value">${fmt(c.value)}</div>${deltaHtml}</div>`;
  }).join('');

  // Trends (last 24h)
  const recent = h.slice(-24);
  if (recent.length > 1) {
    const trendsEl = document.getElementById('trends');
    const metrics = [
      { key: 'visitors', label: 'Visitors', get: e => e.posthog?.visitors },
      { key: 'installs', label: 'Installs', get: e => e.marketplace?.installs },
      { key: 'clicks', label: 'Install Clicks', get: e => e.posthog?.install_clicks },
    ];
    trendsEl.innerHTML = '<h2>24h Trend</h2>' + metrics.map(m => {
      const vals = recent.map(m.get).filter(v => v != null);
      if (!vals.length) return '';
      return `<div class="trend"><strong>${m.label}</strong><div class="sparkline">${vals.map(v => `<span>${fmt(v)}</span>`).join('')}</div></div>`;
    }).join('');
  }

  // UTM
  const sources = l.posthog?.utm_sources;
  if (sources && sources.length) {
    document.getElementById('utm').innerHTML = '<h2>UTM Sources</h2><div class="utm-section">' +
      sources.map(s => `<div class="utm-row"><span class="utm-source">${esc(s.source || s.utm_source || 'unknown')}</span><span>${s.count ?? s.visitors ?? '‚Äî'}</span></div>`).join('') +
      '</div>';
  }
}

function fmt(v) { return typeof v === 'number' ? v.toLocaleString() : v; }
function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

load();
setInterval(load, REFRESH_MS);
</script>
</body>
</html>
